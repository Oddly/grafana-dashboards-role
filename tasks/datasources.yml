---
# --- Elasticsearch datasource ---

- name: Check if ES datasource exists
  ansible.builtin.uri:
    url: "{{ grafana_url }}/api/datasources/name/{{ datasource_def.name | urlencode }}"
    method: GET
    headers:
      Authorization: "{{ _grafana_auth_header }}"
    status_code: [200, 404]
  register: _ds_check
  check_mode: false
  changed_when: false

- name: Create ES datasource
  ansible.builtin.uri:
    url: "{{ grafana_url }}/api/datasources"
    method: POST
    headers:
      Authorization: "{{ _grafana_auth_header }}"
      Content-Type: application/json
    body_format: json
    body: "{{ datasource_def }}"
    status_code: [200]
  when: _ds_check.status == 404
  changed_when: true

- name: Update ES datasource
  ansible.builtin.uri:
    url: "{{ grafana_url }}/api/datasources/{{ _ds_check.json.id }}"
    method: PUT
    headers:
      Authorization: "{{ _grafana_auth_header }}"
      Content-Type: application/json
    body_format: json
    body: "{{ datasource_def | combine({'id': _ds_check.json.id}) }}"
    status_code: [200]
  when: _ds_check.status == 200
  changed_when: true

# --- Infinity datasources (optional) ---

- name: Install Infinity datasources
  when: grafana_dashboards_infinity | bool
  block:
    - name: Check Infinity plugin is installed
      ansible.builtin.uri:
        url: "{{ grafana_url }}/api/plugins/yesoreyeram-infinity-datasource/settings"
        method: GET
        headers:
          Authorization: "{{ _grafana_auth_header }}"
        status_code: [200, 404]
      register: _inf_plugin
      check_mode: false
      changed_when: false

    - name: Warn if Infinity plugin is missing
      ansible.builtin.debug:
        msg: >-
          WARNING: Infinity plugin not found. Install it with:
          grafana-cli plugins install yesoreyeram-infinity-datasource
          then restart Grafana. Skipping Infinity datasource creation.
      when: _inf_plugin.status != 200

    - name: Check Infinity datasources
      ansible.builtin.uri:
        url: "{{ grafana_url }}/api/datasources/name/{{ item.value.name | urlencode }}"
        method: GET
        headers:
          Authorization: "{{ _grafana_auth_header }}"
        status_code: [200, 404]
      loop: "{{ infinity_datasources | dict2items }}"
      loop_control:
        label: "{{ item.key }}"
      register: _inf_ds_checks
      when: _inf_plugin.status == 200
      check_mode: false
      changed_when: false

    - name: Create missing Infinity datasources
      ansible.builtin.uri:
        url: "{{ grafana_url }}/api/datasources"
        method: POST
        headers:
          Authorization: "{{ _grafana_auth_header }}"
          Content-Type: application/json
        body_format: json
        body: "{{ item.item.value }}"
        status_code: [200]
      loop: "{{ _inf_ds_checks.results | default([]) }}"
      loop_control:
        label: "{{ item.item.key | default('skip') }}"
      when:
        - _inf_plugin.status == 200
        - item.status is defined
        - item.status == 404
      changed_when: true

    - name: Update existing Infinity datasources
      ansible.builtin.uri:
        url: "{{ grafana_url }}/api/datasources/{{ item.json.id }}"
        method: PUT
        headers:
          Authorization: "{{ _grafana_auth_header }}"
          Content-Type: application/json
        body_format: json
        body: "{{ item.item.value | combine({'id': item.json.id}) }}"
        status_code: [200]
      loop: "{{ _inf_ds_checks.results | default([]) }}"
      loop_control:
        label: "{{ item.item.key | default('skip') }}"
      when:
        - _inf_plugin.status == 200
        - item.status is defined
        - item.status == 200
      changed_when: true
